<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMFI Visual Mapper v. 4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f1f5f9; color: #0f172a;
            min-height: 100vh; padding: 1rem; overflow: hidden;
        }
        @media (min-width: 768px) { body { padding: 2rem; } }
        ::selection { background-color: #e0e7ff; }

        .container {
            max-width: 1800px; margin: 0 auto; display: flex;
            flex-direction: column; gap: 1rem; height: calc(100vh - 4rem);
        }

        /* Header */
        .header {
            background: white; padding: 1rem 1.5rem; border-radius: 1.25rem;
            border: 1px solid #e2e8f0; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 10;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .brain-icon {
            padding: 0.625rem; background: #4f46e5; border-radius: 0.75rem;
            color: white; box-shadow: 0 4px 12px rgba(79,70,229,0.3); display: flex;
        }
        .header-title { font-size: 1rem; font-weight: 900; letter-spacing: -0.03em; font-style: italic; text-transform: uppercase; }
        .header-title span { font-size: 9px; font-style: normal; font-weight: 600; color: #94a3b8; margin-left: 0.5rem; }
        .operator-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; }
        .operator-label { font-size: 9px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
        .operator-input {
            font-size: 11px; font-weight: 700; color: #4f46e5; background: #eef2ff;
            padding: 0.25rem 0.625rem; border-radius: 0.5rem; border: 1px solid #e0e7ff;
            outline: none; width: 6rem; transition: all 0.2s;
        }
        .operator-input:focus { border-color: #818cf8; box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }

        /* Main */
        .main-content { flex: 1; display: flex; gap: 1rem; overflow: hidden; min-height: 0; }

        /* Canvas */
        .canvas-container {
            flex: 1; background: #e8eaed; border-radius: 1.25rem; border: 1px solid #cbd5e1;
            overflow: hidden; position: relative; cursor: grab;
            background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .canvas-container.panning { cursor: grabbing; }
        .canvas {
            position: absolute; left: 40px; top: 40px; transform-origin: 0 0;
            background: white; padding: 2rem; min-width: 800px;
            border-radius: 1.5rem; box-shadow: 0 20px 60px -15px rgba(0,0,0,0.2);
        }

        /* Zoom */
        .zoom-controls { position: absolute; bottom: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.375rem; z-index: 1000; }
        .zoom-btn {
            width: 36px; height: 36px; border-radius: 0.5rem; border: 1px solid #e2e8f0;
            background: white; color: #475569; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 1.25rem;
            transition: all 0.15s; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .zoom-btn:hover { background: #f8fafc; color: #4f46e5; border-color: #c7d2fe; }
        .zoom-level { text-align: center; font-size: 9px; font-weight: 700; color: #64748b; background: white; padding: 0.375rem; border-radius: 0.375rem; border: 1px solid #e2e8f0; }

        /* Palette */
        .holon-palette { position: absolute; bottom: 1rem; left: 1rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem; }
        .palette-label { font-size: 8px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; text-align: center; }
        .palette-item {
            width: 110px; height: 70px; background: white; border: 2px dashed #a5b4fc;
            border-radius: 0.75rem; display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 0.25rem; cursor: grab; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); user-select: none;
        }
        .palette-item:hover { border-color: #6366f1; background: #f0f4ff; box-shadow: 0 4px 16px rgba(99,102,241,0.2); transform: translateY(-2px); }
        .palette-item:active { cursor: grabbing; transform: scale(0.95); }
        .palette-item-label { font-size: 9px; font-weight: 700; color: #6366f1; }
        .drag-ghost {
            position: fixed; pointer-events: none; z-index: 9999; opacity: 0.85;
            background: white; border: 2px solid #6366f1; border-radius: 0.75rem;
            padding: 0.625rem; width: 130px; height: 55px; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 8px 24px rgba(99,102,241,0.3);
        }

        /* Threshold */
        .threshold { position: relative; padding: 0.75rem 0; display: flex; justify-content: center; }
        .threshold::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 2px; border-top: 2px dashed #cbd5e1; }
        .threshold-label {
            position: relative; background: white; padding: 0.25rem 1.25rem;
            border-radius: 9999px; border: 1px solid #e2e8f0; font-size: 8px;
            font-weight: 800; color: #6366f1; text-transform: uppercase; letter-spacing: 0.3em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .threshold-label.nested { font-size: 7px; padding: 0.125rem 0.75rem; letter-spacing: 0.2em; background: #f8fafc; border-color: #e0e7ff; }

        /* Section labels */
        .section-label {
            display: flex; align-items: center; gap: 0.375rem;
            font-size: 9px; font-weight: 800; color: #64748b;
            text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 0.75rem;
        }
        .section-label.sm { font-size: 7px; margin-bottom: 0.5rem; letter-spacing: 0.15em; }

        /* Holon row (flex container for holons) */
        .holon-row {
            display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: flex-start;
        }
        .holon-row.drop-zone { border-radius: 0.5rem; padding: 0.25rem; margin: -0.25rem; transition: all 0.15s; min-height: 40px; }
        .holon-row.drop-hover { outline: 2.5px dashed #6366f1; outline-offset: 2px; background: rgba(238,242,255,0.5); }

        /* Holon box */
        .holon-box {
            background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem;
            padding: 0.5rem 0.625rem; cursor: pointer; transition: all 0.2s;
            min-height: 54px; min-width: 110px; flex: 0 1 auto;
            display: flex; flex-direction: column; position: relative; overflow: visible;
        }
        .holon-box:hover { border-color: #a5b4fc; box-shadow: 0 4px 12px rgba(99,102,241,0.1); }
        .holon-box.active { border-color: #6366f1; box-shadow: 0 4px 12px rgba(99,102,241,0.2); background: #fafaff; }
        .holon-box .h-not { font-size: 10px; font-weight: 800; color: #475569; margin-bottom: 0.125rem; }
        .holon-box.active .h-not { color: #4f46e5; }
        .holon-box .h-desc { font-size: 8px; color: #94a3b8; line-height: 1.3; font-style: italic; }
        .holon-box .h-preview { margin-top: 0.375rem; padding-top: 0.25rem; border-top: 1px solid #f1f5f9; font-size: 8px; color: #475569; }
        .holon-box .h-preview li { border-left: 2px solid #c7d2fe; padding-left: 0.375rem; margin-bottom: 0.125rem; list-style: none; }
        .holon-box.custom-type { border: 2px solid #a5b4fc; }
        .holon-box.custom-type .h-not { color: #6366f1; }
        .holon-delete {
            position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
            background: #fee2e2; border: 1px solid #fecaca; border-radius: 50%;
            color: #dc2626; font-size: 11px; font-weight: 700; cursor: pointer;
            display: none; align-items: center; justify-content: center; line-height: 1; z-index: 5;
        }
        .holon-box:hover .holon-delete { display: flex; }

        /* Actor container (_bevidst) */
        .actor-container {
            background: linear-gradient(135deg, #fafaff 0%, #f0f4ff 100%);
            border: 2px solid #c7d2fe; border-radius: 1rem; padding: 0.75rem;
            flex: 1 1 320px; min-width: 280px; position: relative; overflow: visible;
        }
        .actor-container[data-depth="1"] { background: linear-gradient(135deg, #fdf9ff 0%, #f5f0ff 100%); border-color: #d8b4fe; }
        .actor-container[data-depth="2"] { background: linear-gradient(135deg, #fff5f7 0%, #fdf0f5 100%); border-color: #fbcfe8; }
        .actor-container[data-depth="3"] { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-color: #fde68a; }
        .actor-container-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.625rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.06); gap: 0.5rem;
        }
        .actor-name-input {
            font-size: 12px; font-weight: 800; color: #4f46e5; background: white;
            border: 1px solid #c7d2fe; border-radius: 0.375rem; padding: 0.25rem 0.5rem;
            outline: none; width: 90px;
        }
        .actor-name-input:focus { border-color: #818cf8; box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }
        .actor-notation-badge {
            font-size: 9px; font-weight: 700; color: #6366f1; background: white;
            padding: 0.125rem 0.5rem; border-radius: 9999px; border: 1px solid #e0e7ff; white-space: nowrap;
        }
        .actor-delete-btn {
            background: #fee2e2; border: 1px solid #fecaca; color: #dc2626;
            padding: 0.2rem 0.5rem; border-radius: 0.375rem; font-size: 9px;
            font-weight: 700; cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .actor-delete-btn:hover { background: #fecaca; }

        /* Add button */
        .add-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.375rem;
            padding: 0.375rem 0.75rem; background: white; border: 2px dashed #c7d2fe;
            border-radius: 0.75rem; color: #6366f1; font-size: 10px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; min-width: 110px; min-height: 45px;
        }
        .add-btn:hover { background: #f0f4ff; border-color: #818cf8; }
        .add-btn.sm { min-width: auto; min-height: auto; padding: 0.25rem 0.5rem; font-size: 9px; border-radius: 0.5rem; }

        /* Resize */
        .resize-handle { position: absolute; z-index: 10; }
        .resize-handle-se { bottom: -4px; right: -4px; width: 12px; height: 12px; cursor: se-resize; }
        .resize-handle-se::after { content: ''; position: absolute; bottom: 3px; right: 3px; width: 6px; height: 6px; border-right: 2px solid #c7d2fe; border-bottom: 2px solid #c7d2fe; }
        .resize-handle-e { right: -3px; top: 10px; bottom: 10px; width: 6px; cursor: e-resize; }
        .resize-handle-s { bottom: -3px; left: 10px; right: 10px; height: 6px; cursor: s-resize; }
        .resize-handle:hover { background: rgba(99,102,241,0.12); border-radius: 2px; }

        /* Detail panel */
        .detail-panel {
            background: white; border-radius: 1.25rem; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
            transition: width 0.3s ease, opacity 0.2s; overflow: hidden;
            display: flex; flex-direction: column; width: 0; opacity: 0;
        }
        .detail-panel.open { width: 360px; opacity: 1; }
        .detail-inner { flex: 1; display: flex; flex-direction: column; min-height: 0; min-width: 360px; }
        .detail-header { padding: 1.25rem; border-bottom: 1px solid #f1f5f9; background: #fafbfc; flex-shrink: 0; }
        .detail-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .detail-title { font-size: 1rem; font-weight: 900; color: #4f46e5; letter-spacing: -0.02em; }
        .detail-subtitle { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.125rem; }
        .close-btn { padding: 0.375rem; background: transparent; border: none; border-radius: 0.375rem; cursor: pointer; color: #94a3b8; transition: all 0.2s; }
        .close-btn:hover { background: #f1f5f9; color: #475569; }
        .info-box { background: white; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #e0e7ff; }
        .info-box p { font-size: 11px; font-style: italic; color: #475569; line-height: 1.5; }
        .detail-body { flex: 1; overflow-y: auto; padding: 1.25rem; }
        .detail-label { font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .detail-textarea {
            width: 100%; min-height: 250px; background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 0.75rem; padding: 1rem; font-size: 12px; color: #334155;
            outline: none; resize: none; font-family: inherit; line-height: 1.6;
        }
        .detail-textarea:focus { border-color: #c7d2fe; box-shadow: 0 0 0 2px rgba(99,102,241,0.1); }

        /* Footer */
        .footer {
            text-align: center; padding: 0.75rem; font-size: 8px; font-weight: 700;
            color: #94a3b8; text-transform: uppercase; letter-spacing: 0.2em;
            flex-shrink: 0; background: white; border-radius: 0.75rem;
        }

        /* Buttons */
        .export-btn, .import-btn {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
            border: none; border-radius: 0.5rem; color: white; font-size: 11px;
            font-weight: 700; cursor: pointer; transition: all 0.15s;
        }
        .export-btn { background: #10b981; } .export-btn:hover { background: #059669; }
        .import-btn { background: #6366f1; } .import-btn:hover { background: #4f46e5; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 2000; padding: 2rem;
        }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; border-radius: 1rem; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid #e2e8f0; }
        .modal-header h2 { font-size: 1rem; font-weight: 800; color: #1e293b; }
        .modal-close { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; }
        .modal-close:hover { background: #f1f5f9; color: #475569; }
        .modal-body { flex: 1; padding: 1.25rem; overflow-y: auto; }
        .modal-textarea { width: 100%; min-height: 400px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-family: 'Consolas',monospace; font-size: 11px; line-height: 1.6; color: #334155; resize: vertical; }
        .modal-textarea:focus { outline: none; border-color: #818cf8; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1rem 1.25rem; border-top: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0 0 1rem 1rem; }
        .modal-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; background: #4f46e5; border: none; border-radius: 0.5rem; color: white; font-size: 12px; font-weight: 700; cursor: pointer; }
        .modal-btn:hover { background: #4338ca; }
        .modal-btn.copied { background: #10b981; }
        .modal-btn.secondary { background: #64748b; }

        /* Conflict tags */
        .holon-tags { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 0.25rem; }
        .holon-tag {
            font-size: 7px; font-weight: 900; letter-spacing: 0.05em;
            padding: 1px 6px; border-radius: 9999px; line-height: 1.5;
            text-transform: uppercase; white-space: nowrap;
        }
        .holon-tag-K1 { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
        .holon-tag-K2 { background: #f3e8ff; color: #7c3aed; border: 1px solid #c4b5fd; }
        .holon-tag-K3 { background: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .holon-tag-K4 { background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        .holon-tag-K5 { background: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
        .holon-tag-K6 { background: #ffe4e6; color: #e11d48; border: 1px solid #fda4af; }

        /* Tag picker in detail panel */
        .tag-picker { display: flex; flex-wrap: wrap; gap: 0.375rem; margin-top: 0.5rem; }
        .tag-picker-btn {
            font-size: 9px; font-weight: 800; padding: 0.25rem 0.625rem;
            border-radius: 9999px; cursor: pointer; transition: all 0.15s;
            border: 2px solid transparent; opacity: 0.5;
        }
        .tag-picker-btn:hover { opacity: 0.8; transform: scale(1.05); }
        .tag-picker-btn.selected { opacity: 1; transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .tag-picker-btn-K1 { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
        .tag-picker-btn-K2 { background: #f3e8ff; color: #7c3aed; border-color: #c4b5fd; }
        .tag-picker-btn-K3 { background: #fef9c3; color: #a16207; border-color: #fde047; }
        .tag-picker-btn-K4 { background: #dbeafe; color: #2563eb; border-color: #93c5fd; }
        .tag-picker-btn-K5 { background: #d1fae5; color: #059669; border-color: #6ee7b7; }
        .tag-picker-btn-K6 { background: #ffe4e6; color: #e11d48; border-color: #fda4af; }

        .icon { width: 20px; height: 20px; }
        .icon-xs { width: 10px; height: 10px; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="brain-icon">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
                        <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
                        <path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/>
                    </svg>
                </div>
                <div>
                    <h1 class="header-title">SMFI NESTED ACTOR MAPPER <span>v. 4.0</span></h1>
                    <div class="operator-row">
                        <span class="operator-label">Operator:</span>
                        <input type="text" id="operatorNameInput" value="Jacob" class="operator-input">
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:0.5rem;">
                <button class="import-btn" onclick="openModal('importModal')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Import
                </button>
                <button class="export-btn" onclick="openExport()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Eksport
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="canvas-container" id="canvasContainer">
                <div class="canvas" id="canvas"></div>
                <div class="holon-palette">
                    <div class="palette-label">Traek ind</div>
                    <div class="palette-item" id="paletteHolon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="4"/><path d="M12 8v8M8 12h8"/></svg>
                        <span class="palette-item-label">Tom Holon</span>
                    </div>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomIn">+</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomOut">&minus;</button>
                    <button class="zoom-btn" id="zoomReset" style="font-size:10px;">&odot;</button>
                </div>
            </div>

            <aside class="detail-panel" id="detailPanel">
                <div class="detail-inner">
                    <div class="detail-header">
                        <div class="detail-header-top">
                            <div>
                                <h3 class="detail-title" id="detailTitle">Holon</h3>
                                <p class="detail-subtitle">Holon-Editor</p>
                            </div>
                            <button class="close-btn" id="closeBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <div class="info-box"><p id="detailDescription">Beskrivelse</p></div>
                    </div>
                    <div class="detail-body">
                        <h4 class="detail-label">Konflikt-tags</h4>
                        <div class="tag-picker" id="tagPicker"></div>
                        <h4 class="detail-label" style="margin-top:1rem;">Observationer & Hypoteser</h4>
                        <textarea id="detailTextarea" class="detail-textarea" placeholder="- Indtast observationer her..."></textarea>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="footer" id="footer">Epistemisk Kohaerens via Lucidiansk Simulation</footer>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Eksport SMFI-analyse</h2><button class="modal-close" onclick="closeModal('exportModal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button></div>
            <div class="modal-body"><div id="exportStats" style="font-size:11px;color:#64748b;margin-bottom:0.75rem;"></div><textarea class="modal-textarea" id="exportTextarea" readonly></textarea></div>
            <div class="modal-footer"><button class="modal-btn" id="copyBtn" onclick="copyExport()"><span id="copyBtnText">Kopier</span></button></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Import SMFI-analyse</h2><button class="modal-close" onclick="closeModal('importModal')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button></div>
            <div class="modal-body"><textarea class="modal-textarea" id="importTextarea" placeholder="Indsaet eksporteret tekst..."></textarea></div>
            <div class="modal-footer"><button class="modal-btn secondary" onclick="closeModal('importModal')">Annuller</button><button class="modal-btn" onclick="processImport()">Importer</button></div>
        </div>
    </div>

<script>
// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
let operatorName = "Jacob";
let activeKey = null;
let holonNotes = {};
let holonSizes = {};
let customHolons = {}; // zoneId -> [{id, title}]
let holonTags = {}; // holonKey -> ['K1', 'K3', ...]

const TAG_DEFS = [
    { id: 'K1', label: 'K1', color: '#dc2626' },
    { id: 'K2', label: 'K2', color: '#7c3aed' },
    { id: 'K3', label: 'K3', color: '#a16207' },
    { id: 'K4', label: 'K4', color: '#2563eb' },
    { id: 'K5', label: 'K5', color: '#059669' },
    { id: 'K6', label: 'K6', color: '#e11d48' },
];

// Recursive actor tree
let actors = [
    { id: 'a1', name: 'Line', children: [] }
];

let _id = 100;
function uid(p) { return p + '_' + (_id++) + '_' + Date.now(); }

// Canvas
let scale = 1, panX = 40, panY = 40, isPanning = false, sx = 0, sy = 0;

// DOM refs
const CC = document.getElementById('canvasContainer');
const CV = document.getElementById('canvas');
const DP = document.getElementById('detailPanel');
const DT = document.getElementById('detailTitle');
const DD = document.getElementById('detailDescription');
const DA = document.getElementById('detailTextarea');

// ═══════════════════════════════════════
// NOTATION
// ═══════════════════════════════════════
function I(n) { return n ? n.charAt(0).toUpperCase() : '?'; }

// notation(['Line'], 'Line', '_Luc.mod.') -> J(L(L))_Luc.mod.
// notation([], 'Jacob', '_Luc.mod.') -> J(J)_Luc.mod.
function N(nesting, target, suffix) {
    const path = [...nesting, target];
    let s = I(path[path.length - 1]);
    for (let i = path.length - 2; i >= 0; i--) s = I(path[i]) + '(' + s + ')';
    return I(operatorName) + '(' + s + ')' + (suffix || '');
}

function D(nesting, target, suffix) {
    const owner = nesting.length > 0 ? nesting[nesting.length - 1] : operatorName;
    if (suffix === '_Luc.mod.') return owner + 's bevidste selvmodel.';
    if (suffix === '_bevidst') return operatorName + ' opfatter ' + target + ' som...';
    if (suffix === '_ideel') return 'Idealiseret billede af ' + target + '.';
    if (suffix === '_Dark_intuition') return 'Dark intuition om ' + target + '.';
    if (!suffix && nesting.length > 0) return owner + 's model af ' + target + '.';
    return '';
}

function K(nesting, target, suffix) {
    return [...nesting.map(I), I(target), suffix || 'main'].join('/');
}

// ═══════════════════════════════════════
// RENDER
// ═══════════════════════════════════════
function render() {
    CV.innerHTML = renderField([], actors, 0);
    document.getElementById('footer').textContent = 'Epistemisk Kohaerens \u00b7 ' + operatorName.toUpperCase();
    requestAnimationFrame(attachResize);
}

function renderField(nesting, fieldActors, depth) {
    const owner = nesting.length > 0 ? nesting[nesting.length - 1] : operatorName;
    const isTop = depth === 0;
    const lbl = isTop ? '' : ' sm';
    const thr = isTop ? '' : ' nested';
    const zone = nesting.length > 0 ? nesting.map(I).join('/') : 'top';

    // MOF holons
    let mofH = renderH(nesting, owner, '_Luc.mod.');
    if (nesting.length > 0 && owner !== operatorName) {
        mofH += renderH(nesting, operatorName, '');
    }
    // Custom MOF holons
    (customHolons[zone + '/mof'] || []).forEach(ch => { mofH += renderCH(ch, zone + '/mof'); });

    // Actor containers
    const nestJson = JSON.stringify(nesting).replace(/"/g, '&quot;');
    let actorsH = fieldActors.map(a => {
        const cn = N(nesting, a.name, '_bevidst');
        return '<div class="actor-container" data-depth="' + depth + '">' +
            '<div class="actor-container-header">' +
                '<input type="text" class="actor-name-input" value="' + a.name + '" ' +
                    'onchange="renameActor(\'' + a.id + '\',this.value)" onclick="event.stopPropagation()" placeholder="Navn">' +
                '<span class="actor-notation-badge">' + cn + '</span>' +
                '<button class="actor-delete-btn" onclick="event.stopPropagation();deleteActor(\'' + a.id + '\')">Slet</button>' +
            '</div>' +
            '<div class="holon-row" style="margin-bottom:0.5rem;">' + renderH(nesting, a.name, '_bevidst') + '</div>' +
            renderField([...nesting, a.name], a.children, depth + 1) +
        '</div>';
    }).join('');

    actorsH += '<button class="add-btn' + (isTop ? '' : ' sm') + '" onclick="addActor(' + nestJson + ')">' +
        '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>' +
        'Tilfoej</button>';

    // LOF holons
    let lofH = renderH(nesting, owner, '_ideel') + renderH(nesting, owner, '_Dark_intuition');
    if (nesting.length > 0 && owner !== operatorName) {
        lofH += renderH(nesting, operatorName, '_ideel') + renderH(nesting, operatorName, '_Dark_intuition');
    }
    fieldActors.forEach(a => {
        lofH += renderH(nesting, a.name, '_ideel') + renderH(nesting, a.name, '_Dark_intuition');
    });
    (customHolons[zone + '/lof'] || []).forEach(ch => { lofH += renderCH(ch, zone + '/lof'); });

    return '<div class="operator-field">' +
        '<div class="mof-section">' +
            '<div class="section-label' + lbl + '">' +
                '<svg class="icon-xs" style="color:#f59e0b;fill:#f59e0b;" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' +
                ' MOF ' + (isTop ? '(Mentalt Operativt Felt)' : '(' + owner + ')') +
            '</div>' +
            '<div class="holon-row drop-zone" data-zone="' + zone + '/mof">' + mofH + '</div>' +
            '<div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem;align-items:flex-start;">' + actorsH + '</div>' +
        '</div>' +
        '<div class="threshold"><span class="threshold-label' + thr + '">Taerskel</span></div>' +
        '<div class="lof-section">' +
            '<div class="section-label' + lbl + '">' +
                '<svg class="icon-xs" style="color:#6366f1;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/><path d="m2 2 20 20"/></svg>' +
                ' LOF ' + (isTop ? '(Latent Operativt Felt)' : '(' + owner + ')') +
            '</div>' +
            '<div class="holon-row drop-zone" data-zone="' + zone + '/lof">' + lofH + '</div>' +
        '</div>' +
    '</div>';
}

function renderH(nesting, target, suffix) {
    const key = K(nesting, target, suffix);
    const not = N(nesting, target, suffix);
    const dsc = D(nesting, target, suffix);
    const notes = holonNotes[key] || '';
    const lines = notes.split('\n').filter(l => l.trim());
    const act = activeKey === key;
    const sz = holonSizes[key] ? 'width:' + holonSizes[key].w + 'px;height:' + holonSizes[key].h + 'px;flex:none;' : '';
    const safeKey = key.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const safeNot = not.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const safeDsc = dsc.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g, '&quot;');

    return '<div class="holon-box' + (act ? ' active' : '') + '" data-hkey="' + key + '" style="' + sz + '" ' +
        'onclick="openH(\'' + safeKey + '\',\'' + safeNot + '\',\'' + safeDsc + '\')">' +
        '<div class="h-not">' + not + '</div>' +
        '<div class="h-desc">' + dsc + '</div>' +
        renderTagBadges(key) +
        (lines.length > 0 ? '<div class="h-preview"><ul>' + lines.map(l => '<li>' + l.replace(/^[-\u2022]\s*/, '') + '</li>').join('') + '</ul></div>' : '') +
    '</div>';
}

function renderTagBadges(key) {
    const tags = holonTags[key];
    if (!tags || tags.length === 0) return '';
    return '<div class="holon-tags">' + tags.map(t => '<span class="holon-tag holon-tag-' + t + '">' + t + '</span>').join('') + '</div>';
}

function renderCH(ch, zone) {
    const act = activeKey === ch.id;
    const notes = holonNotes[ch.id] || '';
    const lines = notes.split('\n').filter(l => l.trim());
    const sz = holonSizes[ch.id] ? 'width:' + holonSizes[ch.id].w + 'px;height:' + holonSizes[ch.id].h + 'px;flex:none;' : '';
    const sz2 = zone.replace(/'/g, "\\'");
    return '<div class="holon-box custom-type' + (act ? ' active' : '') + '" data-hkey="' + ch.id + '" style="' + sz + '" ' +
        'onclick="openH(\'' + ch.id + '\',\'' + ch.title.replace(/'/g, "\\'") + '\',\'Brugerdefineret holon\')">' +
        '<button class="holon-delete" onclick="event.stopPropagation();delCH(\'' + sz2 + '\',\'' + ch.id + '\')">&times;</button>' +
        '<input class="actor-name-input" value="' + ch.title + '" style="font-size:10px;width:80px;margin-bottom:2px;border-color:#a5b4fc;" ' +
            'onchange="renameCH(\'' + sz2 + '\',\'' + ch.id + '\',this.value)" onclick="event.stopPropagation()">' +
        renderTagBadges(ch.id) +
        (lines.length > 0 ? '<div class="h-preview"><ul>' + lines.map(l => '<li>' + l.replace(/^[-\u2022]\s*/, '') + '</li>').join('') + '</ul></div>'
            : '<div class="h-desc">Klik for noter</div>') +
    '</div>';
}

// ═══════════════════════════════════════
// CUSTOM HOLONS
// ═══════════════════════════════════════
function addCH(zone) {
    if (!customHolons[zone]) customHolons[zone] = [];
    customHolons[zone].push({ id: uid('ch'), title: 'Tom Holon' });
    render();
}
function delCH(zone, id) {
    if (customHolons[zone]) customHolons[zone] = customHolons[zone].filter(c => c.id !== id);
    delete holonNotes[id]; delete holonSizes[id];
    if (activeKey === id) closePanel();
    render();
}
function renameCH(zone, id, v) {
    const list = customHolons[zone];
    if (list) { const c = list.find(x => x.id === id); if (c) c.title = v || 'Tom Holon'; }
}

// ═══════════════════════════════════════
// ACTOR MANAGEMENT
// ═══════════════════════════════════════
function findList(nesting) {
    if (nesting.length === 0) return actors;
    let list = actors;
    for (const name of nesting) {
        const a = list.find(x => x.name === name);
        if (!a) return null;
        list = a.children;
    }
    return list;
}

function addActor(nesting) {
    const list = findList(nesting);
    if (!list) return;
    const names = list.map(a => a.name);
    let name = 'Ny'; let c = 1;
    while (names.includes(name)) name = 'Ny' + (++c);
    list.push({ id: uid('a'), name, children: [] });
    render();
}

function deleteActor(id) {
    (function rm(list) {
        const i = list.findIndex(a => a.id === id);
        if (i >= 0) { list.splice(i, 1); return true; }
        return list.some(a => rm(a.children));
    })(actors);
    render();
}

function renameActor(id, v) {
    (function find(list) {
        for (const a of list) {
            if (a.id === id) { a.name = v || '?'; return true; }
            if (find(a.children)) return true;
        }
        return false;
    })(actors);
    render();
}

// ═══════════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════════
function openH(key, title, desc) {
    activeKey = key;
    DT.textContent = title;
    DD.textContent = desc;
    DA.value = holonNotes[key] || '';
    renderTagPicker(key);
    DP.classList.add('open');
    render();
    setTimeout(() => DA.focus(), 200);
}

function renderTagPicker(key) {
    const picker = document.getElementById('tagPicker');
    const current = holonTags[key] || [];
    picker.innerHTML = TAG_DEFS.map(t => {
        const sel = current.includes(t.id) ? ' selected' : '';
        return '<button class="tag-picker-btn tag-picker-btn-' + t.id + sel + '" ' +
            'onclick="event.stopPropagation();toggleTag(\'' + key.replace(/'/g,"\\'") + '\',\'' + t.id + '\')">' + t.label + '</button>';
    }).join('');
}

function toggleTag(key, tagId) {
    if (!holonTags[key]) holonTags[key] = [];
    const idx = holonTags[key].indexOf(tagId);
    if (idx >= 0) holonTags[key].splice(idx, 1);
    else holonTags[key].push(tagId);
    if (holonTags[key].length === 0) delete holonTags[key];
    renderTagPicker(key);
    render();
}

function closePanel() {
    activeKey = null;
    DP.classList.remove('open');
    render();
}

document.getElementById('closeBtn').addEventListener('click', closePanel);
DA.addEventListener('input', e => { if (activeKey) holonNotes[activeKey] = e.target.value; });

// ═══════════════════════════════════════
// ZOOM & PAN
// ═══════════════════════════════════════
function updateT() {
    CV.style.transform = 'translate(' + panX + 'px,' + panY + 'px) scale(' + scale + ')';
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
}

function zoom(d, cx, cy) {
    const old = scale;
    scale = Math.min(2.5, Math.max(0.3, scale + d));
    if (cx !== undefined) {
        const r = CC.getBoundingClientRect();
        const mx = cx - r.left, my = cy - r.top;
        panX = mx - (mx - panX) * (scale / old);
        panY = my - (my - panY) * (scale / old);
    }
    updateT();
}

document.getElementById('zoomIn').addEventListener('click', () => zoom(0.1));
document.getElementById('zoomOut').addEventListener('click', () => zoom(-0.1));
document.getElementById('zoomReset').addEventListener('click', () => { scale = 1; panX = 40; panY = 40; updateT(); });
CC.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY < 0 ? 0.1 : -0.1, e.clientX, e.clientY); }, { passive: false });

CC.addEventListener('mousedown', e => {
    if (e.target.closest('.holon-box,.add-btn,input,button,.actor-container-header,.resize-handle,.palette-item')) return;
    isPanning = true; sx = e.clientX - panX; sy = e.clientY - panY;
    CC.classList.add('panning');
});
document.addEventListener('mousemove', e => { if (!isPanning) return; panX = e.clientX - sx; panY = e.clientY - sy; updateT(); });
document.addEventListener('mouseup', () => { isPanning = false; CC.classList.remove('panning'); });

document.getElementById('operatorNameInput').addEventListener('input', e => { operatorName = e.target.value || 'O'; render(); });
document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === '+' || e.key === '=') zoom(0.1);
    else if (e.key === '-') zoom(-0.1);
    else if (e.key === '0') { scale = 1; panX = 40; panY = 40; updateT(); }
    else if (e.key === 'Escape') closePanel();
});

// ═══════════════════════════════════════
// DRAG FROM PALETTE
// ═══════════════════════════════════════
(function() {
    const pal = document.getElementById('paletteHolon');
    let ghost = null, dragging = false, hovered = null;

    pal.addEventListener('mousedown', e => {
        e.preventDefault(); e.stopPropagation(); dragging = true;
        ghost = document.createElement('div');
        ghost.className = 'drag-ghost';
        ghost.innerHTML = '<span style="font-size:10px;font-weight:800;color:#6366f1;">Tom Holon</span><span style="font-size:7px;color:#94a3b8;">Slip i felt</span>';
        document.body.appendChild(ghost);
        ghost.style.left = (e.clientX - 65) + 'px'; ghost.style.top = (e.clientY - 27) + 'px';
    });

    document.addEventListener('mousemove', e => {
        if (!dragging || !ghost) return;
        ghost.style.left = (e.clientX - 65) + 'px'; ghost.style.top = (e.clientY - 27) + 'px';
        // Find deepest drop zone under cursor
        let best = null;
        document.querySelectorAll('.drop-zone').forEach(z => {
            const r = z.getBoundingClientRect();
            if (e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom) {
                if (!best || best.contains(z)) best = z;
            }
        });
        if (hovered && hovered !== best) hovered.classList.remove('drop-hover');
        if (best) best.classList.add('drop-hover');
        hovered = best;
    });

    document.addEventListener('mouseup', () => {
        if (!dragging) return; dragging = false;
        if (ghost) { ghost.remove(); ghost = null; }
        if (hovered) {
            hovered.classList.remove('drop-hover');
            const z = hovered.dataset.zone;
            if (z) addCH(z);
            hovered = null;
        }
    });
})();

// ═══════════════════════════════════════
// RESIZE
// ═══════════════════════════════════════
function attachResize() {
    document.querySelectorAll('.holon-box, .actor-container').forEach(el => {
        if (el.querySelector('.resize-handle')) return;
        const key = el.dataset.hkey || ('r' + Math.random().toString(36).substr(2,5));
        ['se','e','s'].forEach(dir => {
            const h = document.createElement('div');
            h.className = 'resize-handle resize-handle-' + dir;
            h.dataset.dir = dir;
            el.appendChild(h);
        });
        el.addEventListener('mousedown', e => {
            const h = e.target.closest('.resize-handle');
            if (!h) return;
            e.preventDefault(); e.stopPropagation();
            const x0 = e.clientX, y0 = e.clientY, w0 = el.offsetWidth, h0 = el.offsetHeight;
            function mv(e2) {
                const dx = (e2.clientX - x0) / scale, dy = (e2.clientY - y0) / scale;
                let nw = w0, nh = h0;
                if (h.dataset.dir.includes('e')) nw = Math.max(100, w0 + dx);
                if (h.dataset.dir.includes('s')) nh = Math.max(50, h0 + dy);
                el.style.width = nw + 'px'; el.style.height = nh + 'px'; el.style.flex = 'none';
                holonSizes[key] = { w: nw, h: nh };
            }
            function up() { document.removeEventListener('mousemove', mv); document.removeEventListener('mouseup', up); }
            document.addEventListener('mousemove', mv); document.addEventListener('mouseup', up);
        });
    });
}

// ═══════════════════════════════════════
// EXPORT / IMPORT
// ═══════════════════════════════════════
function openExport() {
    const t = genExport();
    const n = Object.keys(holonNotes).filter(k => holonNotes[k].trim()).length;
    document.getElementById('exportStats').textContent = n + ' holon(er) med indhold';
    document.getElementById('exportTextarea').value = t;
    openModal('exportModal');
}
function copyExport() {
    document.getElementById('exportTextarea').select();
    document.execCommand('copy');
    document.getElementById('copyBtn').classList.add('copied');
    document.getElementById('copyBtnText').textContent = 'Kopieret!';
    setTimeout(() => { document.getElementById('copyBtn').classList.remove('copied'); document.getElementById('copyBtnText').textContent = 'Kopier'; }, 2000);
}
function genExport() {
    const lines = ['='.repeat(60), 'SMFI ANALYSE - ' + operatorName.toUpperCase(), '='.repeat(60), '', 'Operator: ' + operatorName, ''];
    function ex(nesting, fa, depth) {
        const owner = nesting.length > 0 ? nesting[nesting.length - 1] : operatorName;
        const ind = '  '.repeat(depth);
        exH(nesting, owner, '_Luc.mod.', ind);
        if (nesting.length > 0 && owner !== operatorName) exH(nesting, operatorName, '', ind);
        fa.forEach(a => {
            lines.push(ind + '--- ' + N(nesting, a.name, '_bevidst') + ' ---');
            ex([...nesting, a.name], a.children, depth + 1);
        });
        lines.push(ind + '--- LOF ---');
        exH(nesting, owner, '_ideel', ind); exH(nesting, owner, '_Dark_intuition', ind);
        if (nesting.length > 0 && owner !== operatorName) { exH(nesting, operatorName, '_ideel', ind); exH(nesting, operatorName, '_Dark_intuition', ind); }
        fa.forEach(a => { exH(nesting, a.name, '_ideel', ind); exH(nesting, a.name, '_Dark_intuition', ind); });
    }
    function exH(nesting, target, suffix, ind) {
        const key = K(nesting, target, suffix), notes = holonNotes[key];
        const tags = holonTags[key];
        if ((!notes || !notes.trim()) && (!tags || tags.length === 0)) return;
        const tagStr = (tags && tags.length > 0) ? ' [' + tags.join(', ') + ']' : '';
        lines.push(ind + '> ' + N(nesting, target, suffix) + tagStr);
        if (notes) notes.split('\n').filter(l => l.trim()).forEach(l => lines.push(ind + '  ' + l));
        lines.push('');
    }
    ex([], actors, 0);
    lines.push('='.repeat(60));
    return lines.join('\n');
}
function processImport() {
    const text = document.getElementById('importTextarea').value;
    if (!text.trim()) return;
    alert('Import er endnu ikke implementeret i v4. Brug eksport/kopier.');
    closeModal('importModal');
}

// Modal helpers
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => { m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); }); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); });

// ═══════════════════════════════════════
// INIT
// ═══════════════════════════════════════
render();
updateT();
</script>
</body>
</html>
